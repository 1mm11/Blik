<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D Game Platform</title>
    <style>
        /* --- –°–¢–ò–õ–ò --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; overflow: hidden; touch-action: none; }
        .screen { display: none; width: 100%; height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        h1, h2 { margin-bottom: 20px; text-align: center; }
        input, button, textarea { padding: 10px; margin: 5px; width: 100%; max-width: 300px; border-radius: 8px; border: none; font-size: 16px; }
        button { background: #3498db; color: white; cursor: pointer; transition: 0.2s; font-weight: bold; }
        button:active { transform: scale(0.95); }
        button.danger { background: #e74c3c; }
        button.success { background: #2ecc71; }
        button.secondary { background: #555; }
        
        /* –°–ø–∏—Å–∫–∏ –∏–≥—Ä */
        .list-container { width: 100%; max-width: 500px; height: 300px; overflow-y: auto; background: #2c3e50; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        .item-card { background: #34495e; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .status-pending { color: orange; }
        .status-approved { color: lightgreen; }
        .status-rejected { color: tomato; }

        /* –ò–≥—Ä–æ–≤–æ–π –∫–∞–Ω–≤–∞—Å –∏ –†–µ–¥–∞–∫—Ç–æ—Ä */
        #gameCanvas { background: #87CEEB; border: 2px solid white; max-width: 100%; max-height: 70vh; touch-action: none; }
        
        /* –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        .controls { display: flex; gap: 20px; margin-top: 10px; width: 100%; justify-content: center; }
        .control-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid white; font-size: 24px; color: white; display: flex; justify-content: center; align-items: center; user-select: none; }
        
        /* –ü–∞–ª–∏—Ç—Ä–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
        .palette { display: flex; gap: 5px; margin-bottom: 10px; background: #222; padding: 5px; border-radius: 10px; }
        .tile-option { width: 30px; height: 30px; border: 2px solid gray; cursor: pointer; }
        .tile-option.selected { border-color: yellow; }
        
        .toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.5s; pointer-events: none; }
    </style>
</head>
<body>

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div id="screen-login" class="screen active">
        <h1>2D PLATFORM</h1>
        <input type="text" id="login-user" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="auth.login()">–í–æ–π—Ç–∏</button>
        <button class="secondary" onclick="auth.register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div id="screen-menu" class="screen">
        <h2 id="menu-title">–ü—Ä–∏–≤–µ—Ç!</h2>
        <button onclick="app.showCreator()">üõ† –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        <button onclick="app.showBrowser()">üéÆ –ò–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—ã</button>
        <button onclick="app.showFriends()">üë• –î—Ä—É–∑—å—è</button>
        <button id="admin-btn" class="danger" style="display:none;" onclick="app.showAdminPanel()">üîí –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</button>
        <button class="secondary" onclick="app.logout()">–í—ã–π—Ç–∏</button>
    </div>

    <div id="screen-editor" class="screen">
        <h2>–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω—è</h2>
        <div class="palette">
            <div class="tile-option selected" style="background:brown" onclick="editor.selectTile(1)"></div> <div class="tile-option" style="background:gray" onclick="editor.selectTile(2)"></div> <div class="tile-option" style="background:red" onclick="editor.selectTile(3)"></div> <div class="tile-option" style="background:gold" onclick="editor.selectTile(9)"></div> <div class="tile-option" style="background:blue" onclick="editor.selectTile(0)">üóëÔ∏è</div> </div>
        <canvas id="editorCanvas" width="400" height="300"></canvas>
        <div style="margin-top: 10px;">
            <input type="text" id="game-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã">
            <button class="success" onclick="editor.publish()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <button class="secondary" onclick="app.showMenu()">–ù–∞–∑–∞–¥</button>
        </div>
        <small>–†–∏—Å—É–π –ø–∞–ª—å—Ü–µ–º –∏–ª–∏ –º—ã—à–∫–æ–π!</small>
    </div>

    <div id="screen-browser" class="screen">
        <h2>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–≥—Ä</h2>
        <div id="games-list" class="list-container"></div>
        <button class="secondary" onclick="app.showMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="screen-game" class="screen">
        <h2 id="game-title-display">–ò–≥—Ä–∞</h2>
        <canvas id="gameCanvas" width="400" height="300"></canvas>
        <div class="controls">
            <div class="control-btn" ontouchstart="game.input.left=true" ontouchend="game.input.left=false" onmousedown="game.input.left=true" onmouseup="game.input.left=false">‚¨ÖÔ∏è</div>
            <div class="control-btn" ontouchstart="game.input.jump=true" ontouchend="game.input.jump=false" onmousedown="game.input.jump=true" onmouseup="game.input.jump=false">‚¨ÜÔ∏è</div>
            <div class="control-btn" ontouchstart="game.input.right=true" ontouchend="game.input.right=false" onmousedown="game.input.right=true" onmouseup="game.input.right=false">‚û°Ô∏è</div>
        </div>
        <button class="danger" style="margin-top:20px; width: auto;" onclick="game.stop()">–í—ã—Ö–æ–¥</button>
    </div>

    <div id="screen-admin" class="screen">
        <h2>–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
        <div id="admin-list" class="list-container"></div>
        <div id="admin-actions" style="display:none; flex-direction:column; gap:5px;">
            <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–≥—Ä—ã</h3>
            <button class="success" onclick="admin.playTest()">‚ñ∂ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <input type="text" id="reject-reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞">
            <div style="display:flex; gap:5px;">
                <button class="success" onclick="admin.decide(true)">–û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="danger" onclick="admin.decide(false)">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
        <button class="secondary" onclick="app.showMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="screen-friends" class="screen">
        <h2>–î—Ä—É–∑—å—è</h2>
        <input type="text" id="friend-name" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞">
        <button onclick="friends.add()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <div id="friends-list" class="list-container"></div>
        <button class="secondary" onclick="app.showMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        // --- –î–ê–ù–ù–´–ï –ò –°–ò–°–¢–ï–ú–ê (LOCAL STORAGE) ---
        const DB = {
            users: JSON.parse(localStorage.getItem('users')) || [],
            games: JSON.parse(localStorage.getItem('games')) || [],
            save: () => {
                localStorage.setItem('users', JSON.stringify(DB.users));
                localStorage.setItem('games', JSON.stringify(DB.games));
            }
        };

        let currentUser = null;

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        const auth = {
            login: () => {
                const l = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
                if(l === "Doomgane" && p === "doomgame30219") {
                    currentUser = { name: "Doomgane", isAdmin: true, friends: [] };
                    app.initMenu();
                    return;
                }

                const user = DB.users.find(u => u.name === l && u.pass === p);
                if (user) {
                    currentUser = user;
                    app.initMenu();
                } else {
                    showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ —Å–æ–∑–¥–∞–π –∞–∫–∫)");
                }
            },
            register: () => {
                const l = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                if(!l || !p) return showToast("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
                
                if(DB.users.find(u => u.name === l)) return showToast("–ù–∏–∫ –∑–∞–Ω—è—Ç");
                if(l === "Doomgane") return showToast("–≠—Ç–æ—Ç –Ω–∏–∫ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω");

                DB.users.push({ name: l, pass: p, friends: [] });
                DB.save();
                showToast("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ñ–º–∏ –í–æ–π—Ç–∏");
            }
        };

        // --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        const app = {
            initMenu: () => {
                document.getElementById('menu-title').innerText = "–ü—Ä–∏–≤–µ—Ç, " + currentUser.name;
                document.getElementById('admin-btn').style.display = currentUser.isAdmin ? 'block' : 'none';
                showScreen('screen-menu');
            },
            logout: () => {
                currentUser = null;
                showScreen('screen-login');
            },
            showCreator: () => {
                editor.init();
                showScreen('screen-editor');
            },
            showBrowser: () => {
                const list = document.getElementById('games-list');
                list.innerHTML = "";
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –û–î–û–ë–†–ï–ù–ù–´–ï –∏–≥—Ä—ã
                const availableGames = DB.games.filter(g => g.status === 'approved');
                
                if(availableGames.length === 0) list.innerHTML = "<p>–ò–≥—Ä –ø–æ–∫–∞ –Ω–µ—Ç :(</p>";

                availableGames.forEach(g => {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `<span><b>${g.title}</b> –æ—Ç ${g.author}</span> <button class="success" onclick="game.start(${g.id})">–ò–≥—Ä–∞—Ç—å</button>`;
                    list.appendChild(div);
                });
                showScreen('screen-browser');
            },
            showFriends: () => friends.render(),
            showAdminPanel: () => admin.render(),
            showMenu: () => showScreen('screen-menu')
        };

        // --- –†–ï–î–ê–ö–¢–û–† ---
        const editor = {
            canvas: document.getElementById('editorCanvas'),
            ctx: document.getElementById('editorCanvas').getContext('2d'),
            grid: [],
            selectedTile: 1,
            cols: 20, rows: 15, tileSize: 20,

            init: () => {
                editor.grid = Array(editor.rows).fill().map(() => Array(editor.cols).fill(0));
                // –î–µ–ª–∞–µ–º –ø–æ–ª
                for(let x=0; x<editor.cols; x++) editor.grid[editor.rows-1][x] = 1;
                editor.draw();
                editor.setupInput();
            },
            selectTile: (id) => {
                editor.selectedTile = id;
                document.querySelectorAll('.tile-option').forEach(el => el.classList.remove('selected'));
                event.target.classList.add('selected');
            },
            draw: () => {
                editor.ctx.clearRect(0,0,400,300);
                for(let y=0; y<editor.rows; y++){
                    for(let x=0; x<editor.cols; x++){
                        const t = editor.grid[y][x];
                        if(t!==0) {
                            editor.ctx.fillStyle = editor.getColor(t);
                            editor.ctx.fillRect(x*20, y*20, 20, 20);
                        }
                        editor.ctx.strokeStyle = '#333';
                        editor.ctx.strokeRect(x*20, y*20, 20, 20);
                    }
                }
            },
            getColor: (id) => {
                if(id===1) return 'brown';
                if(id===2) return 'gray';
                if(id===3) return 'red';
                if(id===9) return 'gold';
                return 'transparent';
            },
            setupInput: () => {
                let painting = false;
                const paint = (e) => {
                    const rect = editor.canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const x = Math.floor((clientX - rect.left) / 20);
                    const y = Math.floor((clientY - rect.top) / 20);
                    if(x>=0 && x<editor.cols && y>=0 && y<editor.rows) {
                        editor.grid[y][x] = editor.selectedTile;
                        editor.draw();
                    }
                };
                editor.canvas.onmousedown = (e) => { painting=true; paint(e); };
                editor.canvas.onmousemove = (e) => { if(painting) paint(e); };
                editor.canvas.onmouseup = () => painting=false;
                editor.canvas.ontouchstart = (e) => { painting=true; paint(e); e.preventDefault(); };
                editor.canvas.ontouchmove = (e) => { if(painting) paint(e); e.preventDefault(); };
                editor.canvas.ontouchend = () => painting=false;
            },
            publish: () => {
                const name = document.getElementById('game-name').value;
                if(!name) return showToast("–ù–∞–∑–æ–≤–∏ –∏–≥—Ä—É!");
                
                const newGame = {
                    id: Date.now(),
                    title: name,
                    author: currentUser.name,
                    data: editor.grid,
                    status: 'pending', // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É
                    rejectReason: ''
                };
                DB.games.push(newGame);
                DB.save();
                showToast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ê–¥–º–∏–Ω—É!");
                app.showMenu();
            }
        };

        // --- –ò–ì–†–ê (–î–í–ò–ñ–û–ö) ---
        const game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            active: false,
            loopId: null,
            currentLevel: null,
            player: { x: 20, y: 20, vx: 0, vy: 0, w: 15, h: 15, onGround: false },
            input: { left:false, right:false, jump:false },

            start: (id) => {
                const g = DB.games.find(x => x.id === id);
                if(!g) return;
                game.currentLevel = g.data;
                game.player = { x: 50, y: 50, vx: 0, vy: 0, w: 15, h: 15, onGround: false };
                game.active = true;
                showScreen('screen-game');
                document.getElementById('game-title-display').innerText = g.title;
                game.loop();
            },
            stop: () => {
                game.active = false;
                cancelAnimationFrame(game.loopId);
                // –ï—Å–ª–∏ –∞–¥–º–∏–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª, –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω–∫—É, –∏–Ω–∞—á–µ –≤ –º–µ–Ω—é
                if(document.getElementById('screen-admin').style.display === 'flex') return; 
                app.showBrowser();
            },
            update: () => {
                // –§–∏–∑–∏–∫–∞
                if(game.input.left) game.player.vx = -3;
                else if(game.input.right) game.player.vx = 3;
                else game.player.vx = 0;

                if(game.input.jump && game.player.onGround) {
                    game.player.vy = -10;
                    game.player.onGround = false;
                }

                game.player.vy += 0.5; // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                game.player.x += game.player.vx;
                game.checkColl(true); // X –∫–æ–ª–ª–∏–∑–∏—è
                game.player.y += game.player.vy;
                game.checkColl(false); // Y –∫–æ–ª–ª–∏–∑–∏—è

                // –°–º–µ—Ä—Ç—å –≤ —è–º–µ
                if(game.player.y > 300) game.resetPlayer();
            },
            checkColl: (isX) => {
                const p = game.player;
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–∞–π–ª–∞–º
                const top = Math.floor(p.y / 20);
                const bottom = Math.floor((p.y + p.h) / 20);
                const left = Math.floor(p.x / 20);
                const right = Math.floor((p.x + p.w) / 20);

                if(left < 0 || right >= 20 || top < 0 || bottom >= 15) return;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–ª—ã
                const tiles = [
                    game.currentLevel[top][left], game.currentLevel[top][right],
                    game.currentLevel[bottom][left], game.currentLevel[bottom][right]
                ];

                if(tiles.some(t => t === 1 || t === 2)) { // 1 –∏ 2 —Ç–≤–µ—Ä–¥—ã–µ
                    if(!isX) {
                        if(p.vy > 0) { p.y = bottom * 20 - p.h - 0.1; p.onGround = true; p.vy = 0; }
                        else if(p.vy < 0) { p.y = (top + 1) * 20 + 0.1; p.vy = 0; }
                    } else {
                        if(p.vx > 0) p.x = right * 20 - p.w - 0.1;
                        else if(p.vx < 0) p.x = (left + 1) * 20 + 0.1;
                    }
                }
                
                // –õ–∞–≤–∞ (3)
                if(tiles.some(t => t === 3)) game.resetPlayer();
                // –§–∏–Ω–∏—à (9)
                if(tiles.some(t => t === 9)) { showToast("–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!"); game.stop(); }
            },
            resetPlayer: () => {
                game.player.x = 50; game.player.y = 50; game.player.vy = 0;
            },
            draw: () => {
                game.ctx.clearRect(0,0,400,300);
                // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É
                for(let y=0; y<15; y++){
                    for(let x=0; x<20; x++){
                        let t = game.currentLevel[y][x];
                        if(t!==0) {
                            game.ctx.fillStyle = editor.getColor(t);
                            game.ctx.fillRect(x*20, y*20, 20, 20);
                        }
                    }
                }
                // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞
                game.ctx.fillStyle = 'lime';
                game.ctx.fillRect(game.player.x, game.player.y, game.player.w, game.player.h);
            },
            loop: () => {
                if(!game.active) return;
                game.update();
                game.draw();
                game.loopId = requestAnimationFrame(game.loop);
            }
        };

        // --- –ê–î–ú–ò–ù–ö–ê ---
        const admin = {
            selectedGameId: null,
            render: () => {
                showScreen('screen-admin');
                const list = document.getElementById('admin-list');
                list.innerHTML = "";
                
                DB.games.forEach(g => {
                    if(g.status === 'pending') {
                        const div = document.createElement('div');
                        div.className = 'item-card';
                        div.innerHTML = `<span class="status-pending">‚è≥ ${g.title} (${g.author})</span> <button onclick="admin.select(${g.id})">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`;
                        list.appendChild(div);
                    }
                });
                if(list.innerHTML === "") list.innerHTML = "<p>–ù–µ—Ç –∏–≥—Ä –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ.</p>";
                document.getElementById('admin-actions').style.display = 'none';
            },
            select: (id) => {
                admin.selectedGameId = id;
                document.getElementById('admin-actions').style.display = 'flex';
            },
            playTest: () => {
                game.start(admin.selectedGameId);
            },
            decide: (approve) => {
                const reason = document.getElementById('reject-reason').value;
                const gIdx = DB.games.findIndex(x => x.id === admin.selectedGameId);
                
                if(approve) {
                    DB.games[gIdx].status = 'approved';
                    showToast("–ò–≥—Ä–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!");
                } else {
                    DB.games[gIdx].status = 'rejected';
                    DB.games[gIdx].rejectReason = reason || "–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã";
                    showToast("–ò–≥—Ä–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.");
                }
                DB.save();
                admin.render();
            }
        };

        // --- –î–†–£–ó–¨–Ø ---
        const friends = {
            render: () => {
                showScreen('screen-friends');
                const list = document.getElementById('friends-list');
                list.innerHTML = "";
                // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞ –≤ –ë–î —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                const u = DB.users.find(u => u.name === currentUser.name);
                if(!u.friends || u.friends.length === 0) {
                    list.innerHTML = "<p>–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>";
                } else {
                    u.friends.forEach(f => {
                        const div = document.createElement('div');
                        div.className = 'item-card';
                        div.innerHTML = `<span>üë§ ${f}</span>`;
                        list.appendChild(div);
                    });
                }
            },
            add: () => {
                const name = document.getElementById('friend-name').value.trim();
                const uIdx = DB.users.findIndex(u => u.name === currentUser.name);
                const target = DB.users.find(u => u.name === name);

                if(target) {
                    if(!DB.users[uIdx].friends) DB.users[uIdx].friends = [];
                    DB.users[uIdx].friends.push(name);
                    DB.save();
                    currentUser.friends = DB.users[uIdx].friends;
                    friends.render();
                    showToast("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!");
                } else {
                    showToast("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
            }
        };
    </script>
</body>
</html>