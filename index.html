<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlumTik - Admin Control</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #6c5ce7; --bg: #0b0b12; --panel: #161625; --text: #ffffff; --danger: #ff4757; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* SPLASH */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px; }

        /* AUTH */
        #auth-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #0b0b12; color: white; outline: none; }

        /* MAIN */
        #app { display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #222; }
        #search-in { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #0b0b12; color: white; }

        /* SIDEBAR */
        #sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100%; background: var(--panel); z-index: 4000; transition: 0.3s; padding: 25px; }
        #sidebar.active { left: 0; }
        .side-item { padding: 12px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; }

        /* CHAT WINDOW */
        #chat-ui { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        #chat-ui.active { transform: translateX(0); }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; }
        .msg.mine { align-self: flex-end; background: var(--primary); }
        .msg.theirs { align-self: flex-start; background: var(--panel); }

        /* SCREENS */
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 3500; padding: 20px; display: none; flex-direction: column; }
        .screen.active { display: flex; }
        .admin-user-card { background: var(--panel); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="splash">
        <h1 style="font-size:3em; color:var(--primary)">BlumTik</h1>
        <div style="width:260px; margin-top:20px;">
            <button class="btn" onclick="openAuth('login')">Войти</button>
            <button class="btn" style="background:#222" onclick="openAuth('reg')">Зарегистрироваться</button>
        </div>
    </div>

    <div id="auth-modal" class="hidden">
        <div class="auth-box">
            <h2 id="auth-title">Вход</h2>
            <input type="text" id="a-log" placeholder="Ваш ID">
            <input type="password" id="a-pas" placeholder="Пароль">
            <input type="password" id="a-cod" class="hidden" placeholder="Спец-код">
            <button class="btn" style="margin-top:15px" onclick="handleAuth()">Продолжить</button>
            <button class="btn" style="background:none; color:gray" onclick="closeAuth()">Отмена</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <header>
            <i class="fas fa-bars" onclick="toggleMenu(true)"></i>
            <input type="text" id="search-in" placeholder="Поиск по ID..." oninput="searchUser()">
        </header>
        <div id="search-res" style="padding:10px;"></div>
        <div id="chat-list-history" style="flex:1"></div>
    </div>

    <div id="sidebar">
        <div id="my-av-box" style="width:80px; height:80px; background:var(--primary); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2em; overflow:hidden;">B</div>
        <h3 id="my-n2" style="text-align:center">Имя</h3>
        <p id="my-n1" style="text-align:center; color:gray; font-size:0.8em; margin-bottom:20px;">@id</p>
        <div class="side-item" onclick="openScr('profile')"><i class="fas fa-user"></i> Профиль</div>
        <div class="side-item hidden" id="admin-link" onclick="openScr('admin')"><i class="fas fa-user-shield"></i> Админ-панель</div>
        <div class="side-item" style="color:var(--danger); margin-top:30px;" onclick="logout()">Выход</div>
    </div>

    <div id="chat-ui">
        <header>
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <b id="chat-name">Чат</b>
        </header>
        <div id="msgs"></div>
        <div style="padding:15px; background:var(--panel); display:flex; gap:10px;">
            <input type="text" id="msg-input" placeholder="Сообщение..." style="flex:1; background:#0b0b12; border:1px solid #333; color:white; padding:10px; border-radius:10px;">
            <button onclick="sendMessageNow()" style="background:none; border:none; color:var(--primary); font-size:1.5em;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="scr-profile" class="screen">
        <i class="fas fa-arrow-left" onclick="closeScrs()"></i>
        <h2>Профиль</h2>
        <div style="text-align:center; margin-top:20px;">
            <div id="p-av" style="width:100px; height:100px; background:var(--primary); border-radius:50%; margin:0 auto; cursor:pointer; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:2em;" onclick="document.getElementById('f-up').click()">B</div>
            <input type="file" id="f-up" class="hidden" accept="image/*" onchange="uploadAv(this)">
            <input type="text" id="p-n2-in" style="margin-top:20px" placeholder="Новое имя">
            <button class="btn" onclick="saveProf()">Сохранить</button>
        </div>
    </div>

    <div id="scr-admin" class="screen">
        <i class="fas fa-arrow-left" onclick="closeScrs()"></i>
        <h2>Админ-панель</h2>
        <div id="admin-users" style="margin-top:20px; overflow-y:auto;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhneExcv-ElumM5dFvez4_ttk-8H7ci0",
            authDomain: "blik-440b6.firebaseapp.com",
            databaseURL: "https://blik-440b6-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "blik-440b6",
            storageBucket: "blik-440b6.firebasestorage.app",
            messagingSenderId: "652244871814",
            appId: "1:652244871814:web:482e35edeb24141aae887c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let me = null;
        let activeChat = null;
        let isSystemChat = false;

        window.onload = () => {
            const saved = localStorage.getItem('bt_v8');
            if(saved) { me = JSON.parse(saved); launch(); }
        };

        function openAuth(m) {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-title').innerText = m === 'login' ? 'Вход' : 'Регистрация';
            document.getElementById('a-cod').className = m === 'reg' ? '' : 'hidden';
            window.authMode = m;
        }

        function closeAuth() { document.getElementById('auth-modal').classList.add('hidden'); }

        async function handleAuth() {
            const log = document.getElementById('a-log').value.trim().toLowerCase();
            const pas = document.getElementById('a-pas').value.trim();
            const cod = document.getElementById('a-cod').value.trim();
            if(!log || !pas) return alert("Заполни всё!");

            if(window.authMode === 'reg') {
                if(cod !== "21fbhehbebh@934" && cod !== "Admin399u@(_!@#(EJJD") return alert("Код!");
                me = { name1: log, name2: log, password: pas, isAdmin: cod.includes('Admin'), avatar: "" };
                await db.ref('users/' + log).set(me);
                await db.ref('messages/system_' + log).push({ sender: 'BlumTik ✅', text: 'Добро пожаловать в мессенджер!' });
            } else {
                const s = await db.ref('users/' + log).once('value');
                if(!s.exists() || s.val().password !== pas) return alert("Ошибка!");
                me = s.val();
            }
            localStorage.setItem('bt_v8', JSON.stringify(me));
            location.reload();
        }

        function launch() {
            document.getElementById('splash').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('my-n1').innerText = "@" + me.name1;
            document.getElementById('my-n2').innerText = me.name2;
            if(me.isAdmin) {
                document.getElementById('admin-link').classList.remove('hidden');
                loadAdmin();
            }
            updateAvUI();
        }

        async function searchUser() {
            const q = document.getElementById('search-in').value.trim().toLowerCase();
            const res = document.getElementById('search-res');
            if(!q) return res.innerHTML = "";
            const s = await db.ref('users/' + q).once('value');
            if(s.exists() && q !== me.name1) {
                const u = s.val();
                res.innerHTML = `<div class="side-item" onclick="startChat('${u.name1}', '${u.name2}')">
                    <div style="width:40px; height:40px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center;">${u.name1[0].toUpperCase()}</div>
                    <b>${u.name2} (@${u.name1})</b>
                </div>`;
            } else res.innerHTML = "Никого не нашли...";
        }

        function startChat(id, name, isSys = false) {
            isSystemChat = isSys;
            activeChat = isSys ? id : [me.name1, id].sort().join("_");
            document.getElementById('chat-name').innerText = name;
            document.getElementById('chat-ui').classList.add('active');
            
            db.ref('messages/' + activeChat).off();
            db.ref('messages/' + activeChat).on('value', snap => {
                const box = document.getElementById('msgs');
                box.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val();
                    const isMine = d.sender === me.name1 || (isSystemChat && me.isAdmin && d.sender === 'BlumTik ✅');
                    box.innerHTML += `<div class="msg ${isMine ? 'mine' : 'theirs'}">${d.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function sendMessageNow() {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim() || !activeChat) return;
            
            const senderName = (isSystemChat && me.isAdmin) ? "BlumTik ✅" : me.name1;
            
            db.ref('messages/' + activeChat).push({
                sender: senderName,
                text: inp.value.trim(),
                ts: Date.now()
            });
            inp.value = "";
        }

        function loadAdmin() {
            const list = document.getElementById('admin-users');
            db.ref('users').on('value', snap => {
                list.innerHTML = "";
                snap.forEach(u => {
                    const user = u.val();
                    if(user.name1 === me.name1) return;
                    list.innerHTML += `<div class="admin-user-card">
                        <b>${user.name2} (@${user.name1})</b><br><br>
                        <button class="btn" style="padding:5px;" onclick="startChat('system_${user.name1}', 'Бот -> ${user.name2}', true)">Смотреть чат с ботом</button>
                    </div>`;
                });
            });
        }

        function closeChat() { document.getElementById('chat-ui').classList.remove('active'); db.ref('messages/' + activeChat).off(); }
        function toggleMenu(s) { document.getElementById('sidebar').classList.toggle('active', s); }
        function openScr(id) { toggleMenu(false); document.getElementById('scr-'+id).classList.add('active'); }
        function closeScrs() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); }

        function uploadAv(input) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const b64 = e.target.result;
                await db.ref('users/' + me.name1).update({ avatar: b64 });
                me.avatar = b64;
                localStorage.setItem('bt_v8', JSON.stringify(me));
                updateAvUI();
            };
            reader.readAsDataURL(input.files[0]);
        }

        function updateAvUI() {
            const img = me.avatar ? `<img src="${me.avatar}" style="width:100%; height:100%; object-fit:cover;">` : me.name1[0].toUpperCase();
            document.getElementById('my-av-box').innerHTML = img;
            document.getElementById('p-av').innerHTML = img;
        }

        async function saveProf() {
            const n = document.getElementById('p-n2-in').value.trim();
            if(n) {
                await db.ref('users/' + me.name1).update({ name2: n });
                me.name2 = n;
                localStorage.setItem('bt_v8', JSON.stringify(me));
                alert("Имя изменено!");
                launch();
            }
        }

        function logout() { localStorage.removeItem('bt_v8'); location.reload(); }
    </script>
</body>
</html>
