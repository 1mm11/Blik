<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlumTik Ultimate - Persistent</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6c5ce7; --bg: #13131d; --panel: #1e1e2e;
            --text: #ffffff; --text-dim: #a0a0a0; --accent: #fdcb6e; --danger: #ff7675;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        .hidden { display: none !important; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 24px; width: 100%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); text-align: center; }
        .auth-box input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #13131d; color: white; outline: none; }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }

        /* SIDEBAR */
        #sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100%; background: var(--panel); z-index: 1500; transition: 0.4s; padding: 25px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        #sidebar.active { left: 0; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1400; display: none; }
        .sidebar-overlay.active { display: block; }
        .profile-card { text-align: center; margin-bottom: 30px; }
        .avatar-circle { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2em; overflow: hidden; border: 3px solid var(--primary); }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .menu-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
        .menu-item:hover { background: rgba(255,255,255,0.05); }

        /* MAIN APP */
        #main-app { flex: 1; display: flex; flex-direction: column; }
        header { padding: 15px 20px; background: var(--panel); display: flex; align-items: center; gap: 20px; border-bottom: 1px solid #333; }
        .search-bar { flex: 1; position: relative; }
        .search-bar input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: none; background: #13131d; color: white; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim); }
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:var(--primary); margin-bottom:20px;">BlumTik</h1>
            <input type="text" id="reg-login" placeholder="Логин (имя 1)">
            <input type="password" id="access-code" placeholder="Спец-код">
            <input type="password" id="personal-pass" placeholder="Личный пароль">
            <button class="btn-main" onclick="handleAuth()">Войти</button>
            <p id="auth-error" style="color:var(--danger); margin-top:15px; font-size:0.8em;"></p>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar">
        <div class="profile-card">
            <div class="avatar-circle" id="side-avatar">B</div>
            <h3 id="side-name2">Имя 2</h3>
            <p id="side-name1" style="color:var(--text-dim); font-size:0.8em;">@login</p>
        </div>
        <div class="menu-item" onclick="showScreen('chats')"><i class="fas fa-comment"></i> Чаты</div>
        <div class="menu-item" onclick="showScreen('profile')"><i class="fas fa-user-circle"></i> Профиль</div>
        <div id="admin-menu-item" class="menu-item hidden" onclick="showScreen('admin')"><i class="fas fa-user-shield"></i> Админ Панель</div>
        <div class="menu-item" style="margin-top:50px; color:var(--danger)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Выйти из аккаунта</div>
    </div>

    <div id="main-app">
        <header>
            <i class="fas fa-bars" style="cursor:pointer; font-size:1.2em;" onclick="toggleSidebar()"></i>
            <div class="search-bar"><i class="fas fa-search"></i><input type="text" placeholder="Поиск..." id="search-input"></div>
        </header>

        <div id="screen-chats" class="screen active">
            <h2>Ваши чаты</h2>
            <div id="chat-list" style="margin-top:20px;"></div>
        </div>

        <div id="screen-profile" class="screen">
            <h2>Настройки профиля</h2>
            <div class="profile-card" style="margin-top:20px;">
                <div class="avatar-circle" id="prof-avatar-big" style="width:120px; height:120px;">B</div>
                <input type="text" id="change-avatar-url" placeholder="URL аватарки" style="width:100%; padding:10px; margin:10px 0; background:var(--panel); border:none; color:white; border-radius:10px;">
                <input type="text" id="prof-name2-input" placeholder="Имя 2" style="width:100%; padding:10px; background:var(--panel); border:none; color:white; border-radius:10px;">
                <button class="btn-main" style="margin-top:20px;" onclick="saveProfile()">Сохранить</button>
            </div>
        </div>

        <div id="screen-admin" class="screen">
            <h2>Админ Панель</h2>
            <div id="admin-stats" style="margin-top:20px; background:var(--panel); padding:20px; border-radius:15px;">
                <p>Всего пользователей: <b id="stat-total">0</b></p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhneExcv-ElumM5dFvez4_ttk-8H7ci0",
            authDomain: "blik-440b6.firebaseapp.com",
            databaseURL: "https://blik-440b6-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "blik-440b6",
            storageBucket: "blik-440b6.firebasestorage.app",
            messagingSenderId: "652244871814",
            appId: "1:652244871814:web:482e35edeb24141aae887c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        const CODE_USER = "21fbhehbebh@934";
        const CODE_ADMIN = "Admin399u@(_!@#(EJJD";

        // --- ФУНКЦИЯ ПРОВЕРКИ СЕССИИ (ЗАПОМИНАНИЕ) ---
        window.onload = function() {
            const savedUser = localStorage.getItem('blumtik_session');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                startApp();
            }
        };

        async function handleAuth() {
            const login = document.getElementById('reg-login').value.trim().toLowerCase();
            const aCode = document.getElementById('access-code').value.trim();
            const pass = document.getElementById('personal-pass').value.trim();
            const err = document.getElementById('auth-error');

            if (!login || !aCode || !pass) return err.innerText = "Заполни все поля!";

            let isAdminRole = (aCode === CODE_ADMIN);
            if (!isAdminRole && aCode !== CODE_USER) return err.innerText = "Спец-код неверный!";

            const userRef = db.ref('users/' + login);
            const snap = await userRef.once('value');

            if (snap.exists()) {
                if (snap.val().password !== pass) return err.innerText = "Пароль неверный!";
                currentUser = snap.val();
            } else {
                currentUser = {
                    name1: login, name2: login, password: pass,
                    isAdmin: isAdminRole, avatar: "", premium: false,
                    regTime: Date.now(), lastNameChange: 0
                };
                await userRef.set(currentUser);
            }
            
            // СОХРАНЯЕМ В ПАМЯТЬ БРАУЗЕРА
            localStorage.setItem('blumtik_session', JSON.stringify(currentUser));
            startApp();
        }

        function startApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('side-name1').innerText = "@" + currentUser.name1;
            document.getElementById('side-name2').innerText = currentUser.name2;
            document.getElementById('prof-name2-input').value = currentUser.name2;
            if (currentUser.isAdmin) document.getElementById('admin-menu-item').classList.remove('hidden');
            updateAvatarDisplay();
        }

        function logout() {
            localStorage.removeItem('blumtik_session');
            location.reload();
        }

        // --- ОСТАЛЬНАЯ ЛОГИКА ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            toggleSidebar();
        }

        async function saveProfile() {
            const newName2 = document.getElementById('prof-name2-input').value.trim();
            const newAvatar = document.getElementById('change-avatar-url').value.trim();
            let updates = { name2: newName2, avatar: newAvatar };
            
            await db.ref('users/' + currentUser.name1).update(updates);
            currentUser = {...currentUser, ...updates};
            localStorage.setItem('blumtik_session', JSON.stringify(currentUser));
            alert("Обновлено!");
            startApp();
        }

        function updateAvatarDisplay() {
            const url = currentUser.avatar;
            const containers = [document.getElementById('side-avatar'), document.getElementById('prof-avatar-big')];
            containers.forEach(c => {
                if (url) c.innerHTML = `<img src="${url}">`;
                else c.innerHTML = currentUser.name1[0].toUpperCase();
            });
        }
    </script>
</body>
</html>
