<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlumTik - Official</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #6c5ce7; --bg: #0f0f17; --panel: #1e1e2e; --text: #fff; --verify: #1da1f2; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* ЭКРАН ПРИВЕТСТВИЯ */
        #splash-screen { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .splash-logo { font-size: 3.5em; font-weight: 900; color: var(--primary); margin-bottom: 40px; text-shadow: 0 0 20px rgba(108, 92, 231, 0.5); }
        .splash-btns { display: flex; flex-direction: column; gap: 15px; width: 280px; }

        /* ОКНА ВХОДА */
        #auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3100; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 25px; width: 90%; max-width: 380px; text-align: center; border: 1px solid #333; }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; background: #0f0f17; color: white; outline: none; }
        .btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }

        /* ОСНОВНОЙ ИНТЕРФЕЙС */
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px 20px; background: var(--panel); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
        
        /* КНОПКА МЕНЮ */
        .menu-btn { font-size: 1.4em; cursor: pointer; }

        /* БОКОВАЯ ПАНЕЛЬ */
        #sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100%; background: var(--panel); z-index: 4000; transition: 0.3s; padding: 30px 20px; border-right: 1px solid #333; }
        #sidebar.active { left: 0; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3900; display: none; }
        .sidebar-overlay.active { display: block; }

        /* АВАТАРКА */
        .avatar-wrap { width: 90px; height: 90px; border-radius: 50%; background: var(--primary); margin: 0 auto 15px; cursor: pointer; position: relative; overflow: hidden; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 2.5em; }
        .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }

        /* ЧАТЫ */
        #chat-list { flex: 1; overflow-y: auto; padding: 15px; }
        .chat-item { display: flex; align-items: center; padding: 15px; border-radius: 18px; cursor: pointer; margin-bottom: 8px; background: rgba(255,255,255,0.03); }
        .chat-item:hover { background: rgba(255,255,255,0.07); }
        .chat-info { margin-left: 15px; }
        .verify-badge { color: var(--verify); margin-left: 5px; font-size: 0.9em; }

        /* ОКНО ЧАТА */
        #chat-window { position: fixed; inset: 0; background: var(--bg); z-index: 3500; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        #chat-window.active { transform: translateY(0); }
        .chat-header { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 15px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .msg.mine { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 4px; }
        .msg.theirs { align-self: flex-start; background: var(--panel); border-bottom-left-radius: 4px; }

        .input-area { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 12px; }
        .msg-input { flex: 1; background: #0f0f17; border: 1px solid #333; padding: 12px; border-radius: 25px; color: white; outline: none; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">BlumTik</div>
        <div class="splash-btns">
            <button class="btn" onclick="openAuth('login')">Войти</button>
            <button class="btn" style="background:#222" onclick="openAuth('reg')">Зарегистрироваться</button>
        </div>
    </div>

    <div id="auth-overlay" class="hidden">
        <div class="auth-box">
            <h2 id="auth-title">Вход</h2>
            <input type="text" id="auth-login" placeholder="Ваш ID (логин)">
            <input type="password" id="auth-pass" placeholder="Пароль">
            <div id="reg-fields" class="hidden">
                <input type="password" id="auth-code" placeholder="Спец-код">
            </div>
            <button class="btn" style="margin-top:10px" onclick="submitAuth()">Продолжить</button>
            <button class="btn" style="background:none; color:gray; margin-top:5px" onclick="closeAuth()">Отмена</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <i class="fas fa-bars menu-btn" onclick="toggleSidebar(true)"></i>
            <div style="font-weight:900; letter-spacing:1px;">BLUMTIK</div>
            <i class="fas fa-search" style="opacity:0.5"></i>
        </header>

        <div id="chat-list">
            </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div id="sidebar">
        <div class="avatar-wrap" onclick="document.getElementById('file-input').click()" id="my-avatar">B</div>
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="uploadPhoto(this)">
        
        <h3 id="my-name2" style="text-align:center; margin-bottom:5px;">Имя 2</h3>
        <p id="my-name1" style="text-align:center; color:gray; font-size:0.8em; margin-bottom:30px;">@id</p>

        <div class="btn" style="background:none; text-align:left; padding:12px;" onclick="showAdmin()"><i id="adm-shield" class="fas fa-user-shield hidden"></i> Админ-панель</div>
        <div class="btn" style="background:none; text-align:left; padding:12px; color:var(--danger); margin-top:30px;" onclick="logout()">Выйти из аккаунта</div>
    </div>

    <div id="chat-window">
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <div id="target-name" style="font-weight:bold">Чат</div>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <i class="fas fa-circle" style="color:#ff4757; cursor:pointer"></i>
            <input type="text" id="msg-input" class="msg-input" placeholder="Сообщение...">
            <i class="fas fa-microphone" style="color:gray; cursor:pointer"></i>
            <i class="fas fa-paper-plane" style="color:var(--primary); cursor:pointer" onclick="sendMessage()"></i>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAhneExcv-ElumM5dFvez4_ttk-8H7ci0",
            authDomain: "blik-440b6.firebaseapp.com",
            databaseURL: "https://blik-440b6-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "blik-440b6",
            storageBucket: "blik-440b6.firebasestorage.app",
            messagingSenderId: "652244871814",
            appId: "1:652244871814:web:482e35edeb24141aae887c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let activeChatID = null;
        let mode = 'login';

        // ПРОВЕРКА ВХОДА ПРИ ЗАГРУЗКЕ
        window.onload = () => {
            const saved = localStorage.getItem('bt_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                startApp();
            }
        };

        // ОКНА
        function openAuth(m) {
            mode = m;
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('auth-title').innerText = mode === 'login' ? 'Вход' : 'Регистрация';
            document.getElementById('reg-fields').className = mode === 'reg' ? '' : 'hidden';
        }

        function closeAuth() { document.getElementById('auth-overlay').classList.add('hidden'); }

        // ЛОГИКА ВХОДА И РЕГИСТРАЦИИ
        async function submitAuth() {
            const login = document.getElementById('auth-login').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();
            const code = document.getElementById('auth-code').value.trim();

            if (!login || !pass) return alert("Заполни поля!");

            if (mode === 'reg') {
                if (code !== "21fbhehbebh@934" && code !== "Admin399u@(_!@#(EJJD") return alert("Спец-код неверный!");
                const check = await db.ref('users/' + login).once('value');
                if (check.exists()) return alert("Этот ID уже занят!");

                currentUser = {
                    name1: login,
                    name2: login,
                    password: pass,
                    isAdmin: code.includes("Admin"),
                    avatar: ""
                };
                await db.ref('users/' + login).set(currentUser);
                // Системный чат при регистрации
                await db.ref('messages/system_' + login).push({ sender: 'BlumTik ✅', text: 'Добро пожаловать! Это официальный чат поддержки.' });
            } else {
                const snap = await db.ref('users/' + login).once('value');
                if (!snap.exists() || snap.val().password !== pass) return alert("ID или пароль неверный!");
                currentUser = snap.val();
            }

            localStorage.setItem('bt_user', JSON.stringify(currentUser));
            startApp();
        }

        function startApp() {
            document.getElementById('splash-screen').classList.add('hidden');
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.getElementById('my-name1').innerText = "@" + currentUser.name1;
            document.getElementById('my-name2').innerText = currentUser.name2;
            
            if (currentUser.isAdmin) document.getElementById('adm-shield').classList.remove('hidden');
            if (currentUser.avatar) updateAvatarUI(currentUser.avatar);
            
            loadChatList();
        }

        function loadChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = `
                <div class="chat-item" onclick="openChat('system_${currentUser.name1}', 'BlumTik ✅')">
                    <div class="avatar-wrap" style="width:50px; height:50px; margin:0; font-size:1.2em; background:var(--verify)">B</div>
                    <div class="chat-info">
                        <b>BlumTik <i class="fas fa-check-circle verify-badge"></i></b>
                        <div style="font-size:0.8em; color:gray">Официальный чат</div>
                    </div>
                </div>
            `;
        }

        function openChat(id, name) {
            activeChatID = id;
            document.getElementById('target-name').innerText = name;
            document.getElementById('chat-window').classList.add('active');
            loadMessages();
        }

        function closeChat() { document.getElementById('chat-window').classList.remove('active'); }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if (input.value.trim() && activeChatID) {
                db.ref('messages/' + activeChatID).push({
                    sender: currentUser.name1,
                    text: input.value.trim(),
                    time: Date.now()
                });
                input.value = "";
            }
        }

        function loadMessages() {
            const box = document.getElementById('messages');
            db.ref('messages/' + activeChatID).on('value', snap => {
                box.innerHTML = "";
                snap.forEach(m => {
                    const data = m.val();
                    const mine = data.sender === currentUser.name1;
                    const div = document.createElement('div');
                    div.className = `msg ${mine ? 'mine' : 'theirs'}`;
                    div.innerText = data.text;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // РАБОТА С ФОТО
        function uploadPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                await db.ref('users/' + currentUser.name1).update({ avatar: base64 });
                currentUser.avatar = base64;
                localStorage.setItem('bt_user', JSON.stringify(currentUser));
                updateAvatarUI(base64);
            };
            reader.readAsDataURL(file);
        }

        function updateAvatarUI(src) {
            document.getElementById('my-avatar').innerHTML = `<img src="${src}">`;
        }

        function toggleSidebar(show) {
            document.getElementById('sidebar').classList.toggle('active', show);
            document.querySelector('.sidebar-overlay').style.display = show ? 'block' : 'none';
        }

        function logout() {
            localStorage.removeItem('bt_user');
            location.reload();
        }
        
        function showAdmin() {
            if (currentUser.isAdmin) alert("Панель администратора: " + currentUser.name1);
        }

        // Отправка по Enter
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key==='Enter') sendMessage(); };

    </script>
</body>
</html>
