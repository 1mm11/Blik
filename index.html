<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BlumTik - NEXT GEN</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #6c5ce7; --bg: #0f0f17; --panel: #1e1e2e; --text: #fff; --accent: #00d2ff; --verify: #1da1f2; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        .hidden { display: none !important; }

        /* ЭКРАН ПРИВЕТСТВИЯ */
        #splash-screen { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .splash-logo { font-size: 3em; font-weight: 800; color: var(--primary); margin-bottom: 30px; letter-spacing: -2px; }
        .splash-btns { display: flex; flex-direction: column; gap: 15px; width: 250px; }

        /* AUTH BOX */
        #auth-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2500; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--panel); padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #333; background: #0f0f17; color: white; outline: none; }
        .btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }

        /* SIDEBAR */
        #sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100%; background: var(--panel); z-index: 1500; transition: 0.3s; padding: 20px; border-right: 1px solid #333; }
        #sidebar.active { left: 0; }
        .avatar-main { width: 80px; height: 80px; border-radius: 50%; background: var(--primary); margin: 0 auto 10px; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 2em; border: 2px solid var(--primary); }
        .avatar-main img { width: 100%; height: 100%; object-fit: cover; }

        /* CHAT SYSTEM */
        #main-app { flex: 1; display: flex; flex-direction: column; width: 100%; }
        header { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; }
        #chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-row { display: flex; align-items: center; padding: 12px; border-radius: 15px; cursor: pointer; margin-bottom: 5px; transition: 0.2s; }
        .chat-row:hover { background: rgba(255,255,255,0.05); }
        
        #chat-window { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        #chat-window.active { transform: translateX(0); }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 0.95em; position: relative; }
        .msg.mine { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 4px; }
        .msg.theirs { align-self: flex-start; background: var(--panel); border-bottom-left-radius: 4px; }
        
        /* КРУЖОЧКИ И ГС */
        .circle-video { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .audio-msg { display: flex; align-items: center; gap: 10px; }

        .input-area { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 10px; }
        .btn-icon { background: none; border: none; color: var(--text-dim); font-size: 1.3em; cursor: pointer; color: #a0a0a0; }
        .btn-icon:hover { color: var(--primary); }

        /* ADMIN PANEL */
        #admin-screen { padding: 20px; }
        .admin-user-card { background: var(--panel); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">BlumTik</div>
        <div class="splash-btns">
            <button class="btn" onclick="openAuth('login')">Войти</button>
            <button class="btn" style="background:#333" onclick="openAuth('reg')">Зарегистрироваться</button>
        </div>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="auth-box">
            <h2 id="auth-title">Вход</h2>
            <input type="text" id="auth-login" placeholder="Ваш ID (логин)">
            <input type="password" id="auth-pass" placeholder="Пароль">
            <div id="reg-only" class="hidden">
                <input type="password" id="auth-code" placeholder="Спец-код доступа">
            </div>
            <button class="btn" style="margin-top:15px;" onclick="submitAuth()">Подтвердить</button>
            <button class="btn" style="background:none; margin-top:10px; font-size:0.8em;" onclick="closeAuth()">Отмена</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="avatar-main" onclick="document.getElementById('file-input').click()" id="my-avatar">B</div>
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
        <h3 id="my-name2" style="text-align:center">Имя 2</h3>
        <p id="my-name1" style="text-align:center; color:gray; font-size:0.8em; margin-bottom:20px;">@login</p>
        
        <div style="display:flex; flex-direction:column; gap:5px;">
            <div class="btn" style="background:none; text-align:left;" onclick="showTab('chats')"><i class="fas fa-comment"></i> Чаты</div>
            <div class="btn" style="background:none; text-align:left;" onclick="showTab('admin')"><i id="adm-icon" class="fas fa-user-shield hidden"></i> Админка</div>
            <div class="btn" style="background:none; text-align:left; color:var(--danger); margin-top:40px;" onclick="logout()">Выход</div>
        </div>
    </div>

    <div id="main-app">
        <header>
            <i class="fas fa-bars" onclick="document.getElementById('sidebar').classList.toggle('active')"></i>
            <div style="font-weight:bold">BlumTik</div>
        </header>

        <div id="chat-list">
            </div>
    </div>

    <div id="chat-window">
        <header>
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <div id="chat-target-name" style="font-weight:bold">Имя</div>
        </header>
        <div id="messages"></div>
        <div class="input-area">
            <button class="btn-icon" onclick="recordVideo()"><i class="fas fa-circle"></i></button>
            <input type="text" id="msg-input" placeholder="Сообщение...">
            <button class="btn-icon" onclick="recordAudio()"><i class="fas fa-microphone"></i></button>
            <button class="btn-icon" style="color:var(--primary)" onclick="sendMessage()">➤</button>
        </div>
    </div>

    <script>
        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAhneExcv-ElumM5dFvez4_ttk-8H7ci0",
            authDomain: "blik-440b6.firebaseapp.com",
            databaseURL: "https://blik-440b6-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "blik-440b6",
            storageBucket: "blik-440b6.firebasestorage.app",
            messagingSenderId: "652244871814",
            appId: "1:652244871814:web:482e35edeb24141aae887c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let activeChatID = null;
        let authMode = 'login';

        // AUTH LOGIC
        window.onload = () => {
            const saved = localStorage.getItem('bt_session');
            if (saved) { currentUser = JSON.parse(saved); startApp(); }
        }

        function openAuth(mode) {
            authMode = mode;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('auth-title').innerText = mode === 'login' ? 'Вход' : 'Регистрация';
            document.getElementById('reg-only').className = mode === 'login' ? 'hidden' : '';
        }

        function closeAuth() { document.getElementById('auth-screen').classList.add('hidden'); }

        async function submitAuth() {
            const login = document.getElementById('auth-login').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();
            const code = document.getElementById('auth-code').value.trim();

            if (authMode === 'reg') {
                if (code !== "21fbhehbebh@934" && code !== "Admin399u@(_!@#(EJJD") return alert("Код неверный");
                const snap = await db.ref('users/' + login).once('value');
                if (snap.exists()) return alert("ID занят");
                
                currentUser = { name1: login, name2: login, password: pass, isAdmin: (code.includes('Admin')), avatar: "" };
                await db.ref('users/' + login).set(currentUser);
                // Авто-сообщение от системы
                await db.ref('messages/system_' + login).push({ sender: 'BlumTik ✅', text: 'Добро пожаловать в BlumTik! Это ваш личный помощник.' });
            } else {
                const snap = await db.ref('users/' + login).once('value');
                if (!snap.exists() || snap.val().password !== pass) return alert("Ошибка входа");
                currentUser = snap.val();
            }
            localStorage.setItem('bt_session', JSON.stringify(currentUser));
            location.reload();
        }

        function startApp() {
            document.getElementById('splash-screen').classList.add('hidden');
            document.getElementById('my-name1').innerText = "@" + currentUser.name1;
            document.getElementById('my-name2').innerText = currentUser.name2;
            if (currentUser.isAdmin) document.getElementById('adm-icon').classList.remove('hidden');
            if (currentUser.avatar) document.getElementById('my-avatar').innerHTML = `<img src="${currentUser.avatar}">`;
            loadChatList();
        }

        function loadChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = `<div class="chat-row" onclick="openChat('system_${currentUser.name1}', 'BlumTik ✅')">
                <div class="avatar-main" style="width:45px; height:45px; margin:0 15px 0 0; background:var(--verify)">B</div>
                <div><b>BlumTik ✅</b><br><small>Система</small></div>
            </div>`;
            
            // Здесь будет подгрузка остальных ЛС из базы
        }

        function openChat(id, name) {
            activeChatID = id;
            document.getElementById('chat-target-name').innerText = name;
            document.getElementById('chat-window').classList.add('active');
            loadMessages();
        }

        function closeChat() { document.getElementById('chat-window').classList.remove('active'); }

        function sendMessage() {
            const txt = document.getElementById('msg-input').value.trim();
            if (txt && activeChatID) {
                db.ref('messages/' + activeChatID).push({
                    sender: currentUser.name1,
                    text: txt,
                    time: Date.now()
                });
                document.getElementById('msg-input').value = "";
            }
        }

        function loadMessages() {
            const box = document.getElementById('messages');
            db.ref('messages/' + activeChatID).on('value', snap => {
                box.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val();
                    const mine = d.sender === currentUser.name1;
                    const div = document.createElement('div');
                    div.className = `msg ${mine ? 'mine' : 'theirs'}`;
                    div.innerHTML = d.text;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function uploadAvatar(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                await db.ref('users/' + currentUser.name1).update({ avatar: base64 });
                currentUser.avatar = base64;
                localStorage.setItem('bt_session', JSON.stringify(currentUser));
                document.getElementById('my-avatar').innerHTML = `<img src="${base64}">`;
            };
            reader.readAsDataURL(file);
        }

        function logout() { localStorage.removeItem('bt_session'); location.reload(); }

        // ЗАГЛУШКИ ДЛЯ МЕДИА (Требуют защищенного соединения HTTPS)
        function recordAudio() { alert("Голосовое сообщение: Начните говорить..."); }
        function recordVideo() { alert("Кружочек: Камера включена..."); }

    </script>
</body>
</html>
